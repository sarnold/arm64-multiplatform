From fd3b69b2b69e7f6d72769937d4fc99e74fe1e883 Mon Sep 17 00:00:00 2001
From: Steve Arnold <nerdboy@gentoo.org>
Date: Fri, 3 May 2019 17:21:11 -0700
Subject: [PATCH] ARM64 dts marvell espressobin: set spi-flash compatible to
 generic

* rebase of armbian armada-3720-espressobin.dts.patch

Signed-off-by: Steve Arnold <nerdboy@gentoo.org>
---
 .../dts/marvell/armada-3720-espressobin.dts   | 25 ++++++++++++++++---
 1 file changed, 21 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/boot/dts/marvell/armada-3720-espressobin.dts b/arch/arm64/boot/dts/marvell/armada-3720-espressobin.dts
index 7528adf81b9c..804b112412a7 100644
--- a/arch/arm64/boot/dts/marvell/armada-3720-espressobin.dts
+++ b/arch/arm64/boot/dts/marvell/armada-3720-espressobin.dts
@@ -41,6 +41,15 @@
 			  3300000 0x0>;
 		enable-active-high;
 	};
+
+	leds {
+		compatible = "gpio-leds";
+
+		red {
+			label = "espressobin:red:usr";
+			gpios = <&gpionb 2 GPIO_ACTIVE_LOW>;
+		};
+	};
 };
 
 /* J9 */
@@ -95,9 +104,17 @@
 
 	flash@0 {
 		reg = <0>;
-		compatible = "winbond,w25q32dw", "jedec,spi-flash";
+		/*
+		 * Originally "winbond,w25q32dw", but since the manufacturer is known
+		 * to have replaced the part with "macronix,mx25u3235f" in some board
+		 * batches, just use the generic "jedec,spi-nor" and let the actual
+		 * chip type be probed. The partition table still depends on the chip
+		 * being 4 MiB in size.
+		 */
+		compatible = "jedec,spi-nor";
 		spi-max-frequency = <104000000>;
 		m25p,fast-read;
+		status = "okay";
 
 		partitions {
 			compatible = "fixed-partitions";
@@ -106,12 +123,12 @@
 
 			partition@0 {
 				label = "uboot";
-				reg = <0 0x180000>;
+				reg = <0 0x3f0000>;
 			};
 
-			partition@180000 {
+			partition@3f0000 {
 				label = "ubootenv";
-				reg = <0x180000 0x10000>;
+				reg = <0x3f0000 0x10000>;
 			};
 
 			partition@190000 {
-- 
2.20.1

